実装メモ
========

## 患者の前提

- スマートフォンかパソコンが使える。
- メールアドレスを持っていて、メールが読める。
- 電話番号はシステムには登録しない。ただし、保健所と患者で共有している。
- いたずらは常にある。

## Step1

- 入力項目
    + 患者の氏名、ふりがな
    + 誕生月日
    + メールアドレス
- 登録後 xpath, authcode, c3w_wordsを生成してメールする。
- 秘密の質問は下記の理由で不採用。
    + 答えを忘れる可能性。
    + 秘密の質問自体を忘れる可能性。
    + 参考: tag:alpha には「好みの色」がある。

## Step1の考察

- 共通URLでアクセスされるためDOS攻撃対策が必要。
- 一方的にPOSTする。
    + tokenをチェックするためプロセス内で排除できる。
- 入力画面をGETした後にPOSTする。
    + DBとのI/Oが発生するため深刻。
    + 最低でもログを監視してアラートを出す。
    + そしてIPアドレスで動的にブロックするしかない？
    + 同じIPアドレスからの登録を排除するか？NATがいる場合があるので不採用。
    + Cookieを利用して同じなら制限するか？スクリプトを書かれたら効果がない。

## Step1からStep2

- Step2のいたずら防止のため、Step1からStep2にハードルを設ける。
- メールに書かれたリンクにアクセスしてもらう。
- メールに書かれた認証コードを入力してもらう。
- 認証コードとxpathのペアが一致すればStep2に移動する。
- Step1からすぐに遷移する場合、メールに書かれた認証コードを入力してもらう。

## Step1からStep2の考察

- Step1で登録されたメールアドレスにStep2のURLを送る。
- Step1の入力者本人でれば、これを入手できるのでStep2に進むことができる。
- Step1で他人Xが患者Aの不確かな情報を入力し、Xのメールアドレスを入力すると、
- Step2に進むことができる。これによりAの不確かな記録が登録されてしまう。
- これは代理登録とも呼べる。
- 本人確認はStep3で行うので諦めるか？

## Step2

- 入力項目
    + 坂本先生UIに準ずる。

## Step3

- 保健師が患者へ電話をかける。
- 患者からC3Wワードを入手してデータをダウンロードする。
- 保健師がダウンロードしたら:
    + 患者からの入力は不可にする。
    + 研究用DBにコピーする。
        * tsStep4を記録する。
    + 30日間経ったら削除する。

## 主要フィールド

- *1: 患者UIに載るフィールド
- *2: メールに載るフィールド
- emailAddr(*1): 患者の連絡用Eメールアドレス。
    + emailAddrも一意のキーになりえるか？異なる症例で登録されることがあるか？
- pid: 患者の識別コード。
- xpath(*1,*2): 個別の入力画面にアクセスするパス。URLの一部。14日間程度有効
- token(*1): CSRF対策。POSTする時に必須になる。
- c3w_words(*2): 保健師がダウンロードするために患者から伝えられるコード
- c3w_cord: c3w_wordsに対応したコード。必要ないかもしれない。
- authcode: (*2): Step2の認証コード。
- tsStep1: Step1が入力されたタイムスタンプ。1度だけ。
- tsStep2: Step2が入力されたタイムスタンプ。1度だけ。
- tsUpdate: Step2が変更されたタイムスタンプ。保健師がダウンロードするまで。
- tsStep3: 保健師がダウンロードしたタイムスタンプ。
- tsStep4: 研究用DBにコピーしたタイムスタンプ。

## DBのハウスキーピング

- tsStep1が7日以上前で、tsStep2がなければ削除する。
    + 患者がStep1を入力して放置していた。
    + いたずらの可能性あり。
- tsStep2が14日以上前で、tsStep3がなければ削除する。
    + 患者がStep2を入力して、保健師が14日間放置していた。
    + いたずらの可能性あり。
- tsStep3が14日以上前で、tsStep4がなければアラートを出す。
    + 何か異常。tsStep3から2日以内に研究用DBコピーされるはず。
- tsStep4が30日以上前なら削除する。
    + データの保存期限が切れた。

