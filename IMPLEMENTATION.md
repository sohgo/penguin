実装メモ
========

## 患者の前提

- スマートフォンかパソコンが使える。
- メールアドレスを持っていて、メールが読める。
- 電話番号はシステムには登録しない。ただし、保健所と患者で共有している。
- いたずらは常にあることを想定する。
- プライバシーに関わる情報は扱わない。(2021年6月30日追加)

## コンポーネント概略図

<img alt="penguin components" src="doc/pen-arch-20210823-small.png" height="320">

[Docker](https://github.com/tanupoo/proto-pen-docker)を使って動かした場合

フローは[こちら](https://docs.google.com/drawings/d/1w4VkZPMz8jnvWTPGRehubjcRTKzPcMMFceEwjbiA9vM/edit)。
アクセス権が欲しい方は連絡下さい。検討します。

## Step1

```
    UI                                Server
    |  -- GET /1                   --> 
    | <-- Entry UI                 --
    |  -- POST /1 PenEntryModel    --> 
    | <-- PenEntryAckModel         --
```

- 共通URLにアクセスされたらEntry UIを返す。
    + 入力項目
        * メールアドレス
- Entry UIからメールアドレスをPOSTしてもらう。
    + Serverで、xpath, authcode, c3w_wordsを生成する。
    + DBに登録する。
- 入力されたメールアドレスに下記を含めてメールする。
    + xpath, authcode, c3w_words, QRコード

## Step1の考察

- 共通URLでアクセスされるためDOS攻撃対策が必要。
- GETを省略して一方的にPOSTされる。
    + トークンをチェックするためプロセス内で排除できる。
- Step1画面をGETした後にトークンを抜かれPOSTされる。
    + DBとのI/Oが発生し、メールを送信するため深刻。
        * CAPTCHAが考えられる利便性が心配。
        * 視認性の低いものは避けたい。簡単なものにすべき。
        * CAPTCHAも突破可能なので、バランスが難しい。
    + 最低でもログを監視してアラートを出す。
    + そしてIPアドレスで動的にブロックするしかない？
    + 同じIPアドレスからの登録を排除するか？NATがいる場合があるので不採用。
    + Cookieを利用して同じなら制限するか？スクリプトを書かれたら効果がない。
- 患者がメールを認証するために、署名が必要。
    * 難しい。検証も難しい。メールシステムは破綻している。あきらめるか。
- 氏名かなは、保健師は別経路で入手している。はず。
    + 入力させる必要ない？
    + 業務フローでは保健師と接点がない場合もあるのでは？
    + その場合は、電話番号も必要なはず。
    + プライバシーに関わる情報なので除外する。
- 秘密の質問は下記の理由で不採用。
    + 答えを忘れる可能性。
    + 秘密の質問自体を忘れる可能性。
    + 参考: tag:alpha には「好みの色」がある。
- メールアドレスの重複をゆるすかどうか？
    + 間違いで再登録する時にDBの方を消してから登録し直すと手間がかかる。
    + ので、同じメールアドレスで登録を許したほうがよいかと思われる。
    + ひとまず pid,xpathの重複だけをチェックする。
    + DOS対策としては
        * N個まで許すとか？
        * - システム側でチェックしてアラートを出すとか？

## Step1からStep2

- Step2のいたずら防止のため、Step1からStep2にハードルを設ける。
- Step1で登録されたメールアドレスにStep2のURLを送る。
- ユーザは、Step1からメールの画面に移る。
- メールの画面から、メールに書かれたリンクにアクセスする。(Step2クリックモード)
    + その後、メールに書かれた認証コードを入力してもらう。
    + 認証コードとxpathのペアが一致すればStep2に移動する。
- Step1からすぐにStep2に遷移させるか？(Step2透過モード, 20210601現在)
    + メールに書かれた認証コードを入力するだけでよい。
        * メールのリンクをクリックする必要がない。

## Step1からStep2の考察

- ここでわかることは、Step1の入力者がメールアドレスの所有者であること。
- Step1で部外者がXが、Xのメールアドレスを入力してStep2に進み、適当な情報を入力することができる。
    + これは代理登録とも呼べる。
    + 本人確認はStep3で行うので諦める。
- 透過モードの場合、攻撃者はxpathを入手できるため認証コードを突破すればよい。
    + トークンがあるもののスクリプトである程度は突破できるかもしれない。
        + 回程度間違ったら無効にするか？

## Step2

- 入力項目
    + 坂本先生UIに準ずる。
    + プライバシーに関する情報は除外する。(2021年6月30日追加)
- PCを共有することも考えられるため、localStorageは使わない。
- データモデルは下記コードを参照。
    + ui/step2/src/Step2Input1.vue: formData
    + ui/step2/src/Step2Input2.vue: formData
    + ui/step2/src/Step2Input3.vue: formData
    + ui/step2/src/Step2Input4.vue: formData
    + ui/step2/src/InputDaily.vue: formData

## Step3

- 保健師が患者へ電話をかける。
- 患者からC3Wワードを入手してデータをダウンロードする。
- 保健師がダウンロードしたら:
    + 患者からの入力は不可にする。
    + 研究用DBにコピーする。
        * tsStep4を記録する。
    + 30日間経ったら削除する。

## 主要フィールド

- *1: 患者UIに載るフィールド
- *2: メールに載るフィールド
- pid: 患者の識別コード。DBを操作するキー。
    + pid,xpath,c3w_wordsは晒されている。
- emailAddr(*1): 患者の連絡用Eメールアドレス。
    + emailAddrも一意のキーになりえるか？異なる症例で登録されることがあるか？
- xpath(*1,*2): 個別の入力画面にアクセスするパス。URLの一部。14日間程度有効
- token(*1): CSRF対策。POSTする時に必須になる。
- authcode: (*2): Step2の認証コード。
- c3w_words(*2): 保健師がダウンロードするために患者から入手するコード
    + ダウンロード権限のみ。authcodeは編集権限がある。
- c3w_cord: c3w_wordsに対応したコード。必要ないかもしれない。
- tsStep1: Step1が入力されたタイムスタンプ。1度だけ。
- tsStep2: Step2が入力されたタイムスタンプ。1度だけ。
- tsUpdate: Step2が変更されたタイムスタンプ。保健師がダウンロードするまで。
- tsStep3: 保健師がダウンロードしたタイムスタンプ。
- tsStep4: 研究用DBにコピーしたタイムスタンプ。

## DBのハウスキーピング

- tsStep1が7日以上前で、tsStep2がなければ削除する。
    + 患者がStep1を入力して放置していた。
    + いたずらの可能性あり。
- tsStep2が14日以上前で、tsStep3がなければ削除する。
    + 患者がStep2を入力して、保健師が14日間放置していた。
    + いたずらの可能性あり。
- tsStep3が14日以上前で、tsStep4がなければアラートを出す。
    + 何か異常。tsStep3から2日以内に研究用DBコピーされるはず。
- tsStep4が30日以上前なら削除する。
    + データの保存期限が切れた。

## Adminのフロー

保健師がダウンロードするフロー
```
    Client                      Admサーバ
      --- HTTP /dl/3-WORD-CODE -->
      <-- PenAdmDownloadResponseModel ---
```

研究サーバにコピーするフロー
```
    Client                      Admサーバ
      <-- POST /copy PenAdmCopyReqModel --
      --- HTTP 200 OK -->
```

統計情報を取得するフロー
```
    Client                      Admサーバ
      --- GET /stat -->
      <-- PenAminStatAckModel ---
```


