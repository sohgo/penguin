実装メモ
========

## 患者の前提

- スマートフォンかパソコンが使える。
- メールアドレスを持っていて、メールが読める。
- 電話番号はシステムには登録しない。ただし、保健所と患者で共有している。
- いたずらは常にある。

## サーバの証明書

## Step1

- 入力項目
    + 患者の氏名
    + 誕生月日
    + メールアドレス
- 登録後 xpath, authcode, c3w_wordsを生成する。
- 登録されたメールアドレスにメールする。

## Step1の考察

- 共通URLでアクセスされるためDOS攻撃対策が必要。
- GETを省略して一方的にPOSTされる。
    + トークンをチェックするためプロセス内で排除できる。
- Step1画面をGETした後にトークンを抜かれPOSTされる。
    + DBとのI/Oが発生し、メールを送信するため深刻。
        * CAPTCHAが考えられる利便性が心配。
        * 視認性の低いものは避けたい。簡単なものにすべき。
        * CAPTCHAも突破可能なので、バランスが難しい。
    + 最低でもログを監視してアラートを出す。
    + そしてIPアドレスで動的にブロックするしかない？
    + 同じIPアドレスからの登録を排除するか？NATがいる場合があるので不採用。
    + Cookieを利用して同じなら制限するか？スクリプトを書かれたら効果がない。
- 患者がメールを認証するために、署名が必要。
- かなは、保健師は別経路で入手している。はず。
    + 入力させる必要ない？
    + 業務フローでは保健師と接点がない場合もあるのでは？
    + その場合は、電話番号も必要なはず。
- 秘密の質問は下記の理由で不採用。
    + 答えを忘れる可能性。
    + 秘密の質問自体を忘れる可能性。
    + 参考: tag:alpha には「好みの色」がある。

## Step1からStep2

- Step2のいたずら防止のため、Step1からStep2にハードルを設ける。
- Step1で登録されたメールアドレスにStep2のURLを送る。
- Step1から一旦メールの画面に移る。
- そこから、メールに書かれたリンクにアクセスさせる。(Step2クリックモード)
    + その後、メールに書かれた認証コードを入力してもらう。
    + 認証コードとxpathのペアが一致すればStep2に移動する。
- Step1からすぐにStep2に遷移させるか？(Step2透過モード, 20210601現在)
    + メールに書かれた認証コードを入力するだけでよい。
        * リンクをクリックする必要がない。
        * これが手間でなければ、Step2透過モードは必要ない。

## Step1からStep2の考察

- Step1の入力者本人でれば、これを入手できるのでStep2に進むことができる。
- Step1で他人Xが患者Aの不確かな情報を入力し、Xのメールアドレスを入力すると、
- Step2に進むことができる。これによりAの不確かな記録が登録されてしまう。
- これは代理登録とも呼べる。
- 本人確認はStep3で行うので諦めるか？
- 透過モードの場合、攻撃者はxpathを入手できるため認証コードを突破すればよい。
    + トークンがあるもののスクリプトで十分対応可能。
    + よって、透過モードの場合はCAPTCHAが必要と思われる。
        * これも対応可能だがハードルは非常に高い。

## Step2

- 入力項目
    + 坂本先生UIに準ずる。

## Step3

- 保健師が患者へ電話をかける。
- 患者からC3Wワードを入手してデータをダウンロードする。
- 保健師がダウンロードしたら:
    + 患者からの入力は不可にする。
    + 研究用DBにコピーする。
        * tsStep4を記録する。
    + 30日間経ったら削除する。

## 主要フィールド

- *1: 患者UIに載るフィールド
- *2: メールに載るフィールド
- emailAddr(*1): 患者の連絡用Eメールアドレス。
    + emailAddrも一意のキーになりえるか？異なる症例で登録されることがあるか？
- pid: 患者の識別コード。
- xpath(*1,*2): 個別の入力画面にアクセスするパス。URLの一部。14日間程度有効
- token(*1): CSRF対策。POSTする時に必須になる。
- c3w_words(*2): 保健師がダウンロードするために患者から伝えられるコード
- c3w_cord: c3w_wordsに対応したコード。必要ないかもしれない。
- authcode: (*2): Step2の認証コード。
- tsStep1: Step1が入力されたタイムスタンプ。1度だけ。
- tsStep2: Step2が入力されたタイムスタンプ。1度だけ。
- tsUpdate: Step2が変更されたタイムスタンプ。保健師がダウンロードするまで。
- tsStep3: 保健師がダウンロードしたタイムスタンプ。
- tsStep4: 研究用DBにコピーしたタイムスタンプ。

## DBのハウスキーピング

- tsStep1が7日以上前で、tsStep2がなければ削除する。
    + 患者がStep1を入力して放置していた。
    + いたずらの可能性あり。
- tsStep2が14日以上前で、tsStep3がなければ削除する。
    + 患者がStep2を入力して、保健師が14日間放置していた。
    + いたずらの可能性あり。
- tsStep3が14日以上前で、tsStep4がなければアラートを出す。
    + 何か異常。tsStep3から2日以内に研究用DBコピーされるはず。
- tsStep4が30日以上前なら削除する。
    + データの保存期限が切れた。

