実装メモ
========

- 電話番号は保健所が患者と連絡を取るために必須なのでIDに使える。
- 適当に入力されると…

## 秘密の質問
    + 誕生月日
    + 色
    + 1桁また2桁番号は忘れやすいので不採用

## 主要フィールド

- pid: 患者の識別コード。
- xpath: 個別の入力画面にアクセスするパス。URLの一部。14日間程度有効
- token: CSRF対策。POSTする時に必須になる。
- tsStep1: Step1が入力されたタイムスタンプ。1度だけ。
- tsStep2: Step2が入力されたタイムスタンプ。1度だけ。
- tsUpdated: Step2が変更されたタイムスタンプ。保健師がダウンロードするまで。
- tsStep3: 保健師がダウンロードしたタイムスタンプ。
- emailAddr: 患者の連絡用Eメールアドレス。
- c3w_words: 保健師がダウンロードするために患者から伝えられるコード
- c3w_cord: c3w_wordsに対応したコード。必要ないかも？

## ハウスキーピング

- tsStep1が8日前なら削除。
- tsStep2が8日前なら削除。
- tsStep3が15日前なら削除。
- emailAddrも一意のキーになりえるか？異なる症例で登録されることがあるか？

## Step1

- 入力項目
    + 患者の氏名、ふりがな
    + 誕生月日
    + 好みの色
- 登録後 xpathを生成する。

## Step2

- xpathでアクセスされたら秘密の質問を入力する画面を返す。
- 秘密の質問が正しければ入力画面に移動する。
- 入力項目
    + 坂本先生UIに準ずる。

## Step3

- 保健師がダウンロードしたら:
    + 患者からの入力は不可にする。
    + 研究用DBにコピーする。
    + 15日間経ったら削除する。

## Step1の考察

- 共通URLでアクセスされるため工夫が必要。
- 一方的にPOSTする。tokenをチェックするためプロセス内で排除できる。
- 入力画面をGETした後にPOSTする。DBとのI/Oが発生する。
- 同じIPアドレスからの登録を排除する。NATがいる場合があるので不採用。
- Cookieを利用する。
通常のブラウザであれば同じサイトにアクセスすればGETの時に以前のCookieを送る。
サーバはこれをチェックして複数のリクエストを排除できる。
GETの時にCookieを送らなければ攻撃が成立してしまう。

## Step2の考察

- Step1の後に登録されたメールアドレスにStep2のURLを送る。
- Step1の入力者本人でれば、これを入手できるのでStep2に進むことができる。
- Step1で他人Xが患者Aの不確かな情報を入力し、Xのメールアドレスを使う事で、
Step2に進むことができる。これによりAの不確かな記録が登録されてしまう。

